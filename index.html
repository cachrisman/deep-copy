<!DOCTYPE html>
<html>

<head>
  <title>Deep Copy Extension</title>
  <link rel="stylesheet" href="https://unpkg.com/contentful-ui-extensions-sdk@3/dist/cf-extension.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" />
  <style>
    body {
      font-family: "Avenir Next W01", Helvetica, sans-serif;
      font-size: 14px;
      margin: 0;
      color: #8091a5 !important;
      overflow: hidden;
      background-color: #f7f9fa;
    }

    p {
      margin-top: 0;
      margin-bottom: 1em;
    }

    .button {
      display: block;
      position: relative;
      border-right: none;
      overflow: hidden;
      width: 100%;
      height: 40px;
      white-space: nowrap;
      outline: 0;
      padding: 0.625rem 1.5rem;
      cursor: pointer;
      text-align: center;
      font-weight: 500;
      border: 1px solid transparent;
      border-color: #0eb87f;
      border-radius: 2px;
      line-height: 18px;
      color: #fff;
      background: linear-gradient(to top, #0eb87f, #14d997);
      background-size: 100% 200%;
    }

    label {
      font-weight: normal;
    }

  </style>
</head>

<body>
  <div id="content"></div>
  <script id="template-get-content-tree" type="x-tmpl-mustache">
    <div>
      <button id='get-content-tree' class="button cf-block">Get Content Tree</button>
    </div>
  </script>
  <script id="template2" type="x-tmpl-mustache">
    <p>Please select the locales you wish to publish:</p>
    {{#locales}}
    <div>
      <input type="checkbox" id="{{.}}" name="{{.}}" value="{{.}}">
      <label for="{{.}}">{{.}}</label>
    </div>
    {{/locales}}
    <div>
      <button id='locale-publisher-button' class="button cf-block">Publish</button>
    </div>
  </script>
  <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
  <script>
    window.contentfulExtension.init(function(api) {
      window.api = api
      console.log('starting Deep Copy Extension')
      var rendered = Mustache.render(document.getElementById('template-get-content-tree').innerHTML);
      document.getElementById('content').innerHTML = rendered;
      document.getElementById('get-content-tree').addEventListener('click', getContentTree)
      api.window.startAutoResizer();

      var contentTypes
      var counter = 0

      function getContentTree() {
        api.space.getContentTypes().then(response => {
          contentTypes = response.items
          console.log('contentTypes: ', contentTypes);
          let entryId = api.entry.getSys().id
          let finalList = processEntry({
            type: 'entry',
            id: entryId,
            children: []
          })
          Promise.all(finalList).then(_finalList => {
            window.finalList = _finalList
            console.log('finalList: ', window.finalList)
          })
        })
      }

      function processEntry(branch) {
        console.log(counter++)
        if (branch.type === 'Entry') {
          api.space.getEntry(entryId)
          .then(entry => {
            // console.log('entry: ', entry);
            let entryType = entry.sys.contentType.sys.id
            // console.log('entryType: ', entryType);
            let contentType = contentTypes.filter(ct => ct.sys.id === entryType)[0]
            // console.log('contentType: ', contentType);
            // make lists of all the single/multiple entry/asset fields
            let singleReferenceEntryFields = contentType.fields.filter(field => field.type == "Link" && field.linkType == "Entry")
            let multiReferenceEntryFields = contentType.fields.filter(field => field.type == "Array" && field.items.type == "Link" && field.items.linkType == "Entry")
            let singleReferenceAssetFields = contentType.fields.filter(field => field.type == "Link" && field.linkType == "Asset")
            let multiReferenceAssetFields = contentType.fields.filter(field => field.type == "Array" && field.items.type == "Link" && field.items.linkType == "Asset")
            // loop through single reference entry fields, create child object with referenced entry id, push into current branch, and process
            for (field of singleReferenceEntryFields) {
              let refEntryId = entry.fields[field.id]['en-US'].sys.id
              let childObj = {
                type: 'Entry',
                id: refEntryId,
                children: []
              }
              branch.children.push(childObj)
              processEntry(childObj)
            }
            // loop through single reference entry fields, create children objects with referenced entry ids, push into current branch, and process
            for (field of multiReferenceEntryFields) {
              for (ref of entry.fields[field.id]["en-US"]) {
                let refEntryId = ref.sys.id
                let childObj = {
                  type: 'Entry',
                  id: refEntryId,
                  children: []
                }
                branch.children.push(childObj)
                processEntry(childObj)
              }
            }
            // loop through single reference entry fields, create child object with referenced asset id, push into current branch, and process
            for (field of singleReferenceAssetFields) {
              let refEntryId = entry.fields[field.id]['en-US'].sys.id
              let childObj = {
                type: 'Asset',
                id: refEntryId,
              }
              branch.children.push(childObj)
              processEntry(childObj)
            }
            // loop through single reference entry fields, create children objects with referenced asset ids, push into current branch, and process
            for (field of multiReferenceAssetFields) {
              for (ref of entry.fields[field.id]["en-US"]) {
                let refEntryId = ref.sys.id
                let childObj = {
                  type: 'Asset',
                  id: refEntryId
                }
                branch.children.push(childObj)
                processEntry(childObj)
              }
            }
            Promise.all(list).then(list => console.log('list: ', list))
            return branch
          })
          .catch(console.error)
        } else if (branch.type === 'Asset') {

        }
      }
    })

  </script>

</body>


</html>
